# 失語症支援・鼻ポインタ生成AIアプリ 実装ドキュメント

## 概要

このアプリケーションは、MediaPipeを使用した鼻ポインタトラッキング技術と、独自のジェスチャ認識システムを組み合わせた、失語症患者向けの意思疎通支援ツールです。

**主な特徴：**
- リアルタイム鼻位置トラッキング（MediaPipe FaceLandmarker）
- 誤動作防止の2段階確定操作（静止 + 下方向ジェスチャ）
- 直感的なキャンセル操作（上方向ジェスチャ）
- 無操作時の自動復帰（12秒）
- 認知負荷を最小化した3ボタン設計

---

## アーキテクチャ

### 1. MediaPipe統合 (`useNosePointer`)

**ファイル:** `client/src/hooks/useNosePointer.ts`

**機能：**
- ブラウザのカメラからビデオストリームを取得
- FaceLandmarkerを使用して顔の68個のランドマークを検出
- 鼻（ランドマークインデックス1）の3D座標を抽出
- ビデオ座標系をスクリーン座標系に変換
- 信頼度スコア（0.0～1.0）を計算

**ジェスチャ検出ロジック：**
```
前フレーム位置との差分を計算
↓
下方向移動（deltaY > 5 かつ totalDeltaY > screenHeight * 0.05）
→ direction = 'down'
↓
上方向移動（deltaY < -5 かつ totalDeltaY < -screenHeight * 0.05）
→ direction = 'up'
```

**出力インターフェース：**
```typescript
interface PointerPosition {
  x: number;              // スクリーン座標X
  y: number;              // スクリーン座標Y
  confidence: number;     // 信頼度（0.0～1.0）
  isTracking: boolean;    // トラッキング中フラグ
}

interface GestureState {
  direction: 'none' | 'up' | 'down';
  distance: number;       // 移動距離（画面高さの割合）
  duration: number;       // 移動継続時間（ms）
}
```

---

### 2. FSM状態管理 (`usePointerFSM`)

**ファイル:** `client/src/hooks/usePointerFSM.ts`

**状態遷移図：**
```
┌─────────────────────────────────────────────────┐
│                                                 │
│  Idle ←→ Hover ─→ Confirm                      │
│   ↑       ↓                                     │
│   └─── Cancel                                  │
│                                                 │
└─────────────────────────────────────────────────┘

Idle:
  - ボタン外またはキャンセル後の状態
  - ポインタがボタン枠に入ると Hover に遷移

Hover:
  - ボタン枠内にポインタが侵入
  - 300～500ms 静止後、ボタンが視覚変化
  - 下方向ジェスチャで Confirm に遷移
  - 上方向ジェスチャで Cancel に遷移

Confirm:
  - ボタン確定状態
  - スケール + 色変化アニメーション
  - 600ms後に Idle に復帰

Cancel:
  - キャンセル状態
  - Idle に復帰
```

**ボタン境界管理：**
- 各ボタンのDOMRect（x, y, width, height）を登録
- ポインタ位置がボタン内かどうかを判定
- リサイズ時に自動更新

**無操作時の自動復帰：**
- 最後のジェスチャから12秒無操作で自動的に Idle に復帰
- 利用者の疲労時の安全弁

---

### 3. UIコンポーネント

#### 3.1 VirtualPointer
**ファイル:** `client/src/components/VirtualPointer.tsx`

鼻位置を画面上に表示する仮想ポインタ。

**表示要素：**
- 外側の円：トラッキング状態（信頼度に応じた色）
  - 緑（信頼度 > 0.8）
  - 青（信頼度 > 0.6）
  - 赤（信頼度 ≤ 0.6）
- 内側の点：正確な鼻位置

#### 3.2 PointerButton
**ファイル:** `client/src/components/PointerButton.tsx`

鼻ポインタに対応したボタンコンポーネント。

**状態別スタイル：**
```
idle:
  - 白背景、通常サイズ
  - 軽いシャドウ

hover:
  - 青背景、1.1倍スケール
  - 青色のシャドウ

confirm:
  - 緑背景、0.95倍スケール
  - 緑色のリングシャドウ

cancel:
  - 透明度50%
```

#### 3.3 MainSelectionScreen
**ファイル:** `client/src/components/MainSelectionScreen.tsx`

メイン選択画面。3つのボタン（「ほしい」「たすけて」「雑談」）を表示。

**構成：**
```
┌─────────────────────────────────────────┐
│  今、何を伝えたいですか？                 │
│                                         │
│  [ 🎁 ほしい ]  [ 🆘 たすけて ]  [ 💬 雑談 ]  │
│                                         │
│  ─────────────────────────────────────  │
│  ↑ ここでキャンセル                      │
└─────────────────────────────────────────┘
```

#### 3.4 DetailScreen
**ファイル:** `client/src/components/DetailScreen.tsx`

詳細選択画面。選択されたカテゴリ内の詳細オプションを2×2グリッドで表示。

**カテゴリ別アイテム：**
- ほしい：水、ご飯、トイレ、薬
- たすけて：痛い、気分が悪い、動けない、話しかけて
- 雑談：天気、ニュース、家族、思い出

---

## ジェスチャ操作仕様

### 確定操作（下方向ジェスチャ）

**条件：**
1. ポインタがボタン枠内に侵入
2. 300～500ms 静止（ボタンが視覚変化）
3. そこから下方向に画面高の5～8%移動

**効果：**
- ボタンが確定状態に遷移
- 600ms後にアクション実行

### キャンセル操作（上方向ジェスチャ）

**条件A：小さく上方向移動**
- 上方向に画面高の5～8%移動
- 効果：現在の選択をキャンセル、Idle状態に復帰

**条件B：大きく上方向移動**
- 上方向に画面高の15%以上移動
- 効果：メイン画面に戻る（グローバルホームジェスチャ）

**条件C：画面下部「戻るゾーン」侵入**
- 画面最下部80pxのゾーンに侵入
- 効果：キャンセル（Idle状態に復帰）

---

## 技術スタック

| 技術 | 用途 |
|------|------|
| React 19 | UIフレームワーク |
| TypeScript | 型安全性 |
| Tailwind CSS 4 | スタイリング |
| MediaPipe | 鼻トラッキング |
| Vite | ビルドツール |

---

## ファイル構成

```
client/
├── src/
│   ├── hooks/
│   │   ├── useNosePointer.ts      # MediaPipe統合
│   │   └── usePointerFSM.ts       # FSM状態管理
│   ├── components/
│   │   ├── VirtualPointer.tsx     # 仮想ポインタ表示
│   │   ├── PointerButton.tsx      # ポインタ対応ボタン
│   │   ├── MainSelectionScreen.tsx # メイン画面
│   │   └── DetailScreen.tsx       # 詳細画面
│   ├── pages/
│   │   └── Home.tsx               # ホームページ
│   ├── App.tsx                    # ルーティング
│   └── index.css                  # グローバルスタイル
├── public/
│   └── index.html
└── package.json
```

---

## 使用方法

### 1. ブラウザのカメラアクセスを許可

初回起動時、ブラウザがカメラへのアクセス許可を求めます。**「許可」を選択してください。**

### 2. メイン画面で選択

顔がカメラに映るようにセットアップし、鼻を3つのボタンのいずれかに向けます。

**操作フロー：**
```
ボタンにポインタを向ける
↓
300～500ms 静止（ボタンが青く拡大）
↓
下方向に鼻を移動（確定）
↓
ボタンが緑色に変わり、詳細画面に遷移
```

### 3. 詳細画面で選択

同様の操作で詳細オプションを選択します。

### 4. 戻る

上方向に鼻を移動するか、画面下部の「戻るゾーン」に鼻を向けてキャンセルします。

---

## パフォーマンス最適化

### 1. ジェスチャ検出の最適化

- フレーム差分を計算して連続的な移動を検出
- 誤検出を防ぐため、最小移動距離（5px）と最小移動距離率（5%）を設定

### 2. 状態管理の最適化

- FSMを使用して状態遷移を明確化
- 不要な再レンダリングを防ぐためにuseCallbackを活用

### 3. MediaPipeの最適化

- VIDEO runningModeを使用してリアルタイム処理
- 顔数を1に制限（numFaces: 1）

---

## 今後の拡張機能

1. **音声フィードバック**
   - ボタンホバー時のビープ音
   - 確定時の音声確認

2. **視線入力との併用**
   - 瞬きでの確定操作
   - 視線方向の検出

3. **生成AI統合**
   - 選択内容に基づいた自動応答生成
   - バックエンド連携

4. **ユーザーカスタマイズ**
   - ボタンラベルの編集
   - ジェスチャ感度の調整
   - 色スキームの変更

5. **アクセシビリティ向上**
   - 高コントラストモード
   - 大型フォント対応
   - 音声ガイダンス

---

## トラブルシューティング

### カメラが起動しない

**原因：** ブラウザのカメラアクセスが許可されていない

**対策：**
1. ブラウザの設定でカメラへのアクセスを許可
2. ページをリロード
3. 別のブラウザで試す

### 鼻が検出されない

**原因：** 照明が不十分、または顔がカメラに映っていない

**対策：**
1. 照明を改善（逆光を避ける）
2. カメラの位置を調整
3. 顔全体がカメラに映るようにする

### ジェスチャが反応しない

**原因：** 移動速度が速すぎるか、移動距離が不足

**対策：**
1. ゆっくり、大きく鼻を動かす
2. 画面下部の「戻るゾーン」を使用してキャンセル

---

## ライセンス

MIT License

---

## 参考資料

- [MediaPipe Face Landmarker](https://developers.google.com/mediapipe/solutions/vision/face_landmarker)
- [MediaPipe Tasks Vision](https://github.com/google-ai-edge/mediapipe/tree/master/mediapipe/tasks/web/vision)
